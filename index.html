<!DOCTYPE html>
<html>
  <head>
    <title>MovieTube (API Control)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Estilos generales */
      .hero-background {
          background-size: cover;
          background-position: center;
      }
      .focus\:ring-4:focus {
        outline: none;
      }
      .line-clamp-2 {
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
          max-height: 3rem; 
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white min-h-screen">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    </script>

    <script type="text/babel">
      
      // Variable global para almacenar el objeto de los videos que están listos para la API
      window.onYouTubeIframeAPIReady = () => {
        console.log("YouTube API lista.");
        // Después de que la API esté lista, notificamos a React que debe re-renderizarse 
        // o podemos usar un evento si la estructura de la app fuera más compleja.
        // Por simplicidad, React reaccionará cuando se intente renderizar el componente.
      };

      // ----------------------------------------------------------------------
      // LÓGICA DE CONVERSIÓN Y EXTRACCIÓN DE ID
      // ----------------------------------------------------------------------

      function obtenerVideoInfo(url) {
          const defaultVideoId = 'dQw4w9WgXcQ';
          let videoId = defaultVideoId;
          let isYouTube = false;

          if (url) {
              const youtubeRegex = /(?:youtube\.com|youtu\.be)\/(?:v=|embed\/|watch\?v=|\/v\/)?([a-zA-Z0-9_-]{11})/;
              const match = url.match(youtubeRegex);

              if (match && match[1]) {
                  videoId = match[1];
                  isYouTube = true;
              }
          }

          if (isYouTube) {
              // URL base para el contenedor de la API (solo necesitamos el ID)
              const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`; 
              return { videoId, thumbnailUrl, isYouTube };
          } else {
              // Para videos externos, mantenemos la lógica anterior
              const thumbnailUrl = "https://placehold.co/1920x1080/1F2937/fff?text=VIDEO+EXTERNO"; 
              return { videoId: null, thumbnailUrl, isYouTube: false };
          }
      }

      // ----------------------------------------------------------------------
      // COMPONENTE ReproductorEnFoco (CON CONTROLES PERSONALIZADOS)
      // ----------------------------------------------------------------------

      function ReproductorEnFoco({ videoUrl, onBack }) {
          const { videoId, isYouTube } = obtenerVideoInfo(videoUrl);
          const [player, setPlayer] = React.useState(null);
          const [isMuted, setIsMuted] = React.useState(true);
          const [isPlaying, setIsPlaying] = React.useState(false);
          const controlButtonRef = React.useRef(null); // Ref para el primer botón de control

          // 2. Hook para inicializar el reproductor con la API de YouTube
          React.useEffect(() => {
              if (!isYouTube || !videoId || !window.YT || player) {
                  return; // Si no es YouTube o el reproductor ya existe, salir
              }

              // El ID del div donde se inyectará el reproductor
              const playerId = 'youtube-player-container'; 
              
              // Inicialización del nuevo objeto YT.Player
              const newPlayer = new window.YT.Player(playerId, {
                  videoId: videoId,
                  playerVars: {
                      'autoplay': 1,
                      'controls': 0, // Deshabilitar controles nativos de YouTube
                      'mute': 1, // Mutear para asegurar el autoplay
                      'disablekb': 1, // Deshabilitar controles de teclado de YouTube (opcional, pero ayuda)
                  },
                  events: {
                      'onReady': (event) => {
                          setPlayer(newPlayer);
                          newPlayer.unMute(); // Desmutear al estar listo para que el usuario controle el audio
                          setIsMuted(false);
                          // Forzar el foco al primer botón de control al cargar el reproductor
                          if (controlButtonRef.current) {
                              controlButtonRef.current.focus(); 
                          }
                      },
                      'onStateChange': (event) => {
                        // Actualizar estado de Play/Pause
                        if (event.data === window.YT.PlayerState.PLAYING) {
                            setIsPlaying(true);
                        } else if (event.data === window.YT.PlayerState.PAUSED || event.data === window.YT.PlayerState.ENDED) {
                            setIsPlaying(false);
                        }
                      }
                  }
              });

              // Función de limpieza para destruir el reproductor al desmontar
              return () => {
                  if (newPlayer && typeof newPlayer.destroy === 'function') {
                      newPlayer.destroy();
                  }
              };
          }, [videoId, isYouTube, player]);


          // MÉTODOS DE CONTROL
          const togglePlayPause = () => {
              if (!player) return;
              if (player.getPlayerState() === window.YT.PlayerState.PLAYING) {
                  player.pauseVideo();
              } else {
                  player.playVideo();
              }
          };

          const toggleMute = () => {
              if (!player) return;
              if (player.isMuted()) {
                  player.unMute();
                  setIsMuted(false);
              } else {
                  player.mute();
                  setIsMuted(true);
              }
          };


          // ICONOS (SVG)
          const PlayIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4.004a1 1 0 001.555.832l3.224-2.002a1 1 0 000-1.664l-3.224-2.002z" clipRule="evenodd" /></svg>;
          const PauseIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 011 1v4a1 1 0 11-2 0V7a1 1 0 011-1zm-3 4a1 1 0 002 0V7a1 1 0 00-2 0v4z" clipRule="evenodd" /></svg>;
          const VolumeIcon = () => isMuted ? 
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zm10.024 2.193a1 1 0 010 1.414L17.243 10l2.164 2.163a1 1 0 01-1.414 1.414L15.829 11.414l-2.163 2.164a1 1 0 01-1.414-1.414L14.414 10l-2.163-2.163a1 1 0 011.414-1.414l2.163 2.164 2.164-2.163a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
              :
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 5.059a1 1 0 011.414 0 9 9 0 010 12.582 1 1 0 11-1.414-1.414 7 7 0 000-9.754 1 1 0 010-1.414zM16.071 3.645a1 1 0 011.414 0 11 11 0 010 15.69 1 1 0 11-1.414-1.414 9 9 0 000-12.862 1 1 0 010-1.414z" clipRule="evenodd" /></svg>;


          return (
              <div className="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center">
                  
                  {/* Botón Volver */}
                  <button 
                      onClick={onBack}
                      className="absolute top-4 left-4 p-3 bg-gray-700 text-white rounded-full text-lg z-50 
                                transition-all hover:bg-gray-600 focus:ring-4 focus:ring-red-500 focus:outline-none"
                      tabIndex="0" 
                  >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                      </svg>
                  </button>

                  {/* Contenedor del Reproductor y Controles */}
                  <div className="w-full h-full p-4 flex flex-col items-center justify-center relative">
                      
                      {/* 3. Contenedor para inyectar el Iframe de YouTube API */}
                      <div className="aspect-video w-full max-w-screen-xl relative">
                          {/* El Iframe se inyectará aquí por la API, pero el div debe estar visible y tener el ID */}
                          <div id="youtube-player-container" className="w-full h-full rounded-xl shadow-2xl">
                              {/* Contenido de fallback para videos no-YouTube */}
                              {!isYouTube && (
                                  <iframe
                                      tabIndex="0"
                                      className="w-full h-full rounded-xl shadow-2xl bg-gray-900 border-none"
                                      src={videoUrl}
                                      allow="autoplay; fullscreen"
                                      allowFullScreen
                                  ></iframe>
                              )}
                          </div>
                      </div>

                      {/* 4. Controles Personalizados (Enfocables) */}
                      {isYouTube && (
                          <div className="flex space-x-6 mt-8 p-4 bg-gray-800 rounded-xl shadow-2xl">
                              
                              {/* Botón Mute/Unmute */}
                              <button 
                                  onClick={toggleMute}
                                  ref={controlButtonRef} // Asignamos la ref al primer botón para enfoque inicial
                                  className="text-white p-3 rounded-full bg-red-600 hover:bg-red-700 
                                            focus:ring-4 focus:ring-white focus:outline-none"
                                  tabIndex="0"
                              >
                                  <VolumeIcon />
                              </button>

                              {/* Botón Play/Pause */}
                              <button 
                                  onClick={togglePlayPause}
                                  className="text-white p-3 rounded-full bg-red-600 hover:bg-red-700 
                                            focus:ring-4 focus:ring-white focus:outline-none"
                                  tabIndex="0"
                              >
                                  {isPlaying ? <PauseIcon /> : <PlayIcon />}
                              </button>
                              
                              {/* Puedes añadir más controles (ej. pantalla completa, avance) */}
                              {/* Nota: El control de volumen es más complejo y requeriría un slider, 
                                          pero el MUTE es un buen inicio */}

                          </div>
                      )}
                  </div>
              </div>
          );
      }


      // ----------------------------------------------------------------------
      // COMPONENTES HERO BANNER Y TARJETA (sin cambios relevantes en la lógica D-Pad)
      // ----------------------------------------------------------------------

      const HeroBanner = React.forwardRef(({ titulo, descripcion, videoUrl, onPlay }, ref) => {
          const { thumbnailUrl } = obtenerVideoInfo(videoUrl);

          return (
              <div 
                  className="hero-background w-full min-h-[50vh] flex items-end relative overflow-hidden mb-10 rounded-xl shadow-2xl"
                  tabIndex="-1" 
                  style={{ backgroundImage: `url('${thumbnailUrl}'), url('https://placehold.co/1920x1080/0d1117/333?text=CARGANDO...')` }}
              >
                  <div className="absolute inset-0 bg-black/60"></div>

                  <div className="relative p-10 max-w-xl">
                      <h2 className="text-5xl font-extrabold mb-3 text-white drop-shadow-lg">
                          {titulo}
                      </h2>
                      <p className="text-lg mb-6 text-gray-200 drop-shadow-md">
                          {descripcion}
                      </p>

                      <button 
                          ref={ref} 
                          onClick={() => onPlay(videoUrl)} 
                          className="inline-block px-8 py-3 bg-red-600 text-white font-bold rounded-lg shadow-lg 
                                  transition-all duration-300 hover:bg-red-700 
                                  focus:ring-4 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-900 focus:outline-none"
                          tabIndex="0" 
                      >
                          Ver Ahora
                      </button>
                  </div>
              </div>
          );
      });
      HeroBanner.displayName = 'HeroBanner';


      function ReproductorDeVideo(props) {
        const { videoId, thumbnailUrl, isYouTube } = obtenerVideoInfo(props.url);
        const genericPlaceholderUrl = "https://placehold.co/600x337/333/fff?text=VIDEO+EXTERNO";

        const handleImageError = (e) => {
            e.target.onerror = null; 
            if (isYouTube && videoId && e.target.src.includes('maxresdefault')) {
                e.target.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                return;
            } 
            e.target.src = genericPlaceholderUrl;
        };

        return (
          <div 
            className="video-card cursor-pointer group relative overflow-hidden bg-gray-800 rounded-xl shadow-lg 
                        transition-all duration-300 hover:shadow-2xl hover:scale-[1.05] 
                        focus:ring-4 focus:ring-red-500 focus:outline-none"
            onClick={() => props.onPlay(props.url)} 
            tabIndex="0" 
          >
            <img 
                src={thumbnailUrl} 
                onError={handleImageError} 
                className="w-full aspect-video object-cover transition duration-500 group-hover:opacity-75"
                alt={`Miniatura de ${props.titulo}`}
            />

            <div className="p-4">
              <h2 className="text-lg font-semibold text-red-400 group-focus:text-red-300 line-clamp-2">
                {props.titulo || "Título del Video"}
              </h2>
              <p className="mt-1 text-gray-400 text-sm">
                Fuente: {isYouTube ? "YouTube" : "Externa"}
              </p>
            </div>

          </div>
        );
      }

      // ----------------------------------------------------------------------
      // COMPONENTE PRINCIPAL APP (Maneja el estado y el foco al volver)
      // ----------------------------------------------------------------------

      function App() {
          const [videoEnFocoUrl, setVideoEnFocoUrl] = React.useState(null);
          const heroButtonRef = React.useRef(null); 

          const handleBack = React.useCallback(() => {
              setVideoEnFocoUrl(null);
              setTimeout(() => {
                  if (heroButtonRef.current) {
                      heroButtonRef.current.focus();
                  }
              }, 0);
          }, []);


          if (videoEnFocoUrl) {
              return <ReproductorEnFoco 
                  videoUrl={videoEnFocoUrl} 
                  onBack={handleBack} 
              />;
          }

          const heroVideoUrl ="https://youtu.be/GwPAvxA62Do?si=aK5qDPYMPfpkTS8o";

          return (
              <div className="p-4 md:p-8 max-w-7xl mx-auto">
                  <HeroBanner 
                      ref={heroButtonRef}
                      titulo="Estreno de la Semana"
                      descripcion="Controles D-Pad funcionales en reproductor."
                      videoUrl={heroVideoUrl}
                      onPlay={setVideoEnFocoUrl} 
                  />

                  <h1 className="text-3xl font-bold mb-6 text-red-600">
                      Explorar Videos
                  </h1>

                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <ReproductorDeVideo titulo="Controlable con D-Pad" url={heroVideoUrl} onPlay={setVideoEnFocoUrl} />
                    <ReproductorDeVideo titulo="Trailer de Película" url="https://youtu.be/9eGzFLWuSmY?si=cGpQoCGegKj2LI2k" onPlay={setVideoEnFocoUrl} />
                    <ReproductorDeVideo titulo="Tutorial de React JS" url="https://youtu.be/epUe_LPcq-k?si=8dmditU-6Y2ieEd" onPlay={setVideoEnFocoUrl} />
                    <ReproductorDeVideo titulo="Tecnología 2025" url="https://youtu.be/P59WtHvSd18?si=Qz-lcl-a1MrNU5b8" onPlay={setVideoEnFocoUrl} />
                    <ReproductorDeVideo titulo="Clásico de los 80s" url="https://youtu.be/T8SYLvGEBkk?si=4QnLS9WPwQu4cQgo" onPlay={setVideoEnFocoUrl} />
                    <ReproductorDeVideo titulo="Viaje por la Galaxia" url="https://youtu.be/chmuJSP-V8Y?si=YHCUZ3fSuhpIGqNg" onPlay={setVideoEnFocoUrl} />
                    <ReproductorDeVideo titulo="Entrevista a Chef" url="https://youtu.be/9eGzFLWuSmY?si=cGpQoCGegKj2LI2k" onPlay={setVideoEnFocoUrl} />
                    <ReproductorDeVideo titulo="Recetas Rápidas" url="https://youtu.be/gwkUDXSGbxg?si=eLcpoLsvJP6kr7d2" onPlay={setVideoEnFocoUrl} />
                    <ReproductorDeVideo titulo="El Misterio del Lago" url="https://youtu.be/qYfJ36XxEpc?si=_SicDPM0kU8WR_AY" onPlay={setVideoEnFocoUrl} />
                  </div>
              </div>
          );
      }

      // 7. MONTAJE DE LA APLICACIÓN
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(<App />);
    </script>
  </body>
</html>
